<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>bba-worldwide-stats-2012-geometries - Google Fusion Tables</title>
    <style type="text/css">
     html, body, #map_canvas {
       margin: 0;
       padding: 0;
       height: 100%;
     }
    </style>
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3.7&amp;sensor=false"></script>
    <script type="text/javascript">
    var center = new google.maps.LatLng(32.0000,-5.0000);
    var zoom = 2;
    var legend_width = '150px';
    var tableid = "1YlY2lX9Qilt3nbfOM6GU7y33TDuUZ6iCe0LcDzU";
    var location_column = 'geometry';
    var columns = {
    'Rank': [
      {
        'min': 0,
        'max': 10,
        'color': '#EC2424'
      },
      {
        'min': 10,
        'max': 50,
        'color': '#FEC30F'
      },
      {
        'min': 50,
        'max': 100,
        'color': '#EEF08E'
      }
    ],

    'Peoples under threat score': [
      {
        'min': 7,
        'max': 10,
        'color': '#EEF08E'
      },
      {
        'min': 10,
        'max': 20,
        'color': '#FEC30F'
      },
      {
        'min': 20,
        'max': 30,
        'color': '#EC2424'
      }
    ],
    'Human development index': [
      {
        'min': 0.2,
        'max': 0.4,
        'color': '#EC2424'
      },
      {
        'min': 0.4,
        'max': 0.6,
        'color': '#FEC30F'
      },
          {
        'min': 0.6,
        'max': 0.8,
        'color': '#AAD1EE'
      },
      {
        'min': 0.8,
        'max': 1,
        'color': '#2D5CAA'
      }
    ]
    };

    var map, layer;

    function initialize() {

        map = new google.maps.Map(document.getElementById('map_canvas'), {
          center: center,
          zoom: zoom,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var style = [
          {
            featureType: 'administrative',
            elementType: 'all',
            stylers: [
              { visibility: 'off' }
            ]
          },{ elementType: "labels", stylers: [ { saturation: -100 } ] },{ elementType: "geometry", stylers: [ { gamma: 0.78 }, { saturation: -100 }, { lightness: 98 } ] },{ featureType: "road", elementType: "geometry", stylers: [ { lightness: -13 } ] }
        ];

        var styledMapType = new google.maps.StyledMapType(style, {
          map: map,
          name: 'Styled Map'
        });

        map.mapTypes.set('map-style', styledMapType);
        map.setMapTypeId('map-style');


        layer = new google.maps.FusionTablesLayer({
          query: {
            select: location_column,
            from: tableid
          }
        });
        layer.setMap(map);

        init_selectmenu();
        addStyle(getKey());
    }

    function getKey() {
        for (key in columns) {
          return key;
        }
    }

    // Initialize the drop-down menu
    function init_selectmenu() {
        var selectmenu = document.getElementById('selector');
        for(column in columns) {
          var option = document.createElement('option');
          option.setAttribute('value', column);
          option.innerHTML = column;
          selectmenu.appendChild(option);
        }
    }

    // Apply the style to the layer
    function addStyle(column) {
        var defined_styles = columns[column];
        var styles = new Array();

        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          styles.push({
            where: generateWhere(column, style.min, style.max),
            polygonOptions: {
              fillColor: style.color,
              fillOpacity: style.opacity ? style.opacity : 1
            }
          });
        }

        layer.set('styles', styles);
        updateLegend(column);
    }

    // Create the where clause
    function generateWhere(column_name, low, high) {
        var whereClause = new Array();
        whereClause.push("'");
        whereClause.push(column_name);
        whereClause.push("' >= ");
        whereClause.push(low);
        whereClause.push(" AND '");
        whereClause.push(column_name);
        whereClause.push("' < ");
        whereClause.push(high);
        return whereClause.join('');
    }

    // Create the legend with the corresponding colors
    function updateLegend(column) {
        var legendDiv = document.createElement('div');
        var legend = new Legend(legendDiv, column);
        legendDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop();
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendDiv);
    }

    // Generate the content for the legend
    function Legend(controlDiv, column) {
        controlDiv.style.padding = '10px';
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = 'white';
        controlUI.style.borderStyle = 'solid';
        controlUI.style.borderWidth = '1px';
        controlUI.style.width = legend_width;
        controlUI.title = 'Legend';
        controlDiv.appendChild(controlUI);
        var controlText = document.createElement('div');
        controlText.style.fontFamily = 'Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.paddingLeft = '4px';
        controlText.style.paddingRight = '4px';

        controlText.innerHTML = legendContent(column);
        controlUI.appendChild(controlText);
    }

    function legendContent(column) {
        var defined_styles = columns[column];

        // Generate the content for the legend using colors from object
        var controlTextList = new Array();
        controlTextList.push('<p><b>');
        controlTextList.push(column);
        controlTextList.push('</b></p>');
        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          controlTextList.push('<div style="background-color: ');
          controlTextList.push(style.color);
          controlTextList.push('; height: 20px; width: 20px; margin: 3px; float: left;"></div>');
          controlTextList.push(style.min);
          controlTextList.push(' to ');
          controlTextList.push(style.max);
          controlTextList.push('<br style="clear: both;"/>');
        }

        controlTextList.push('<br />');
        return controlTextList.join('');
    }

    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
    <select onchange="addStyle(this.value);" id="selector" style="font-size: 14px"></select>
    <div id="map_canvas"></div>
</body>
</html>