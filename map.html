<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>British Foreign &amp; Commonwealth Office (FCO) | Britons in trouble abroad | 2011-2012</title>
    <link rel="icon" type="image/vnd.microsoft.icon" href="http://www.fco.gov.uk/sitepack/layouts/xm_supplied/icon/favicon.ico" />
    <style type="text/css">
     html, body, #map_canvas {
       margin: 0;
       padding: 0;
       height: 100%;
       background-color: #fff;
     }
     body {
      font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
     }
    </style>
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3.7&amp;sensor=false"></script>
    <script type="text/javascript">
    var center = new google.maps.LatLng(32.0000, -5.0000);
    var zoom = 2;
    var legend_width = '150px';
    var tableid = '1BBIBUVGrhCits7gz1o4oarrVHLiWkq48ejwKMyU';
    var location_column = 'geometry';
    var colors = {
      'NA': '#DADADA',
      'COLD': '#2D5CAA',
      'CHILLY': '#AAD1EE',
      'MILD': '#EEF08E',
      'WARM': '#FEC30F',
      'HOT': '#EC2424'
    };
    var columns = {
      'Total assistance': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 6000,
          'color': colors.HOT
        }      
      ],
      'Drug arrests': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.WARM
        },
        {
          'min': 50,
          'max': 150,
          'color': colors.HOT
        }
      ],
      'Total arrests or detentions': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Deaths': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Hospitalisation': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Victims of rape': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 15,
          'color': colors.WARM
        },
        {
          'min': 15,
          'max': 20,
          'color': colors.HOT
        }      
      ],
      'Victims of sexual assault': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 15,
          'color': colors.WARM
        },
        {
          'min': 15,
          'max': 25,
          'color': colors.HOT
        }      
      ],
      'Issue of emergency travel documentation': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 6000,
          'color': colors.HOT
        }      
      ],
      'Other kinds of assistance': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 600,
          'color': colors.HOT
        }      
      ]
    };

    var map, layer, currentColumn, infoWindow;

    function initialize() {

        map = new google.maps.Map(document.getElementById('map_canvas'), {
          center: center,
          zoom: zoom,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var style = [
          {
            featureType: 'administrative',
            elementType: 'all',
            stylers: [
              { visibility: 'off' }
            ]
          },
          { 
            elementType: "labels", 
            stylers: [ 
              { saturation: -100 } 
            ] 
          },
          { 
            elementType: "geometry", 
            stylers: [ 
              { gamma: 0.78 }, { saturation: -100 }, { lightness: 98 } 
            ] 
          },
          { 
            featureType: "road", 
            elementType: "geometry", 
            stylers: [ 
              { lightness: -13 } 
            ] 
          }
        ];

        var styledMapType = new google.maps.StyledMapType(style, {
          map: map,
          name: 'Styled Map'
        });

        map.mapTypes.set('map-style', styledMapType);
        map.setMapTypeId('map-style');

        infoWindow = new google.maps.InfoWindow();

        layer = new google.maps.FusionTablesLayer({
          query: {
            select: location_column,
            from: tableid
          },
          suppressInfoWindows: true
        });
        
        var clickListener = (function() {
          
          var template = "<div style='font-family:sans-serif' class='googft-info-window'><b>{{country}}</b><br><b>{{key}}:</b> {{value}}<br></div>";

          return function(opts) {
            var value = opts.row[currentColumn.toLowerCase()].value;
            var renderedContent = (template
              .replace("{{country}}", opts.row.Country.value)
              .replace("{{key}}", currentColumn)
              .replace("{{value}}", value >= 5 && value || "Below threshold for counting"));

            infoWindow.close()
            infoWindow.setContent(renderedContent);
            infoWindow.setPosition(opts.latLng);
            infoWindow.open(map);
          };

        })();

        google.maps.event.addListener(layer, 'click', clickListener);

        layer.setMap(map);

        init_selectmenu();
        addStyle(getKey());
    }

    function getKey() {
        for (key in columns) {
          return key;
        }
    }

    // Initialize the drop-down menu
    function init_selectmenu() {
        var selectmenu = document.getElementById('selector');
        for(column in columns) {
          var option = document.createElement('option');
          option.setAttribute('value', column);
          option.innerHTML = column;
          selectmenu.appendChild(option);
        }
    }

    // Apply the style to the layer
    function addStyle(column) {
        var defined_styles = columns[column];
        var styles = new Array();

        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          styles.push({
            where: generateWhere(column, style.min, style.max),
            polygonOptions: {
              fillColor: style.color,
              fillOpacity: style.opacity ? style.opacity : 1
            }
          });
        }

        layer.set('styles', styles);
        updateLegend(column);
        infoWindow.close();
        currentColumn = column;

        try {
          window.parent.$(window.parent.document).trigger("mapUpdated", column);
        } catch (err) {}
    }

    // Create the where clause
    function generateWhere(column_name, low, high) {
        var whereClause = new Array();
        whereClause.push("'");
        whereClause.push(column_name.toLowerCase());
        whereClause.push("' >= ");
        whereClause.push(low);
        whereClause.push(" AND '");
        whereClause.push(column_name.toLowerCase());
        whereClause.push("' < ");
        whereClause.push(high);
        return whereClause.join('');
    }

    // Create the legend with the corresponding colors
    function updateLegend(column) {
        var legendDiv = document.createElement('div');
        var legend = new Legend(legendDiv, column);
        legendDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop();
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendDiv);
    }

    // Generate the content for the legend
    function Legend(controlDiv, column) {
        controlDiv.style.padding = '10px';
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = 'white';
        controlUI.style.borderStyle = 'solid';
        controlUI.style.borderWidth = '1px';
        controlUI.style.width = legend_width;
        controlUI.title = 'Legend';
        controlDiv.appendChild(controlUI);
        var controlText = document.createElement('div');
        controlText.style.fontFamily = 'Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.paddingLeft = '4px';
        controlText.style.paddingRight = '4px';

        controlText.innerHTML = legendContent(column);
        controlUI.appendChild(controlText);
    }

    function legendContent(column) {
        var defined_styles = columns[column];

        // Generate the content for the legend using colors from object
        var controlTextList = new Array();
        controlTextList.push('<p><b>');
        controlTextList.push(column);
        controlTextList.push('</b></p>');
        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          controlTextList.push('<div style="background-color: ');
          controlTextList.push(style.color);
          controlTextList.push('; height: 20px; width: 20px; margin: 3px; float: left;"></div>');
          if (style.max <= 5) {
            controlTextList.push('Below threshold');
          } else {
            controlTextList.push(style.min);
            controlTextList.push(' to ');
            controlTextList.push(style.max);
          }
          controlTextList.push('<br style="clear: both;"/>');
        }

        controlTextList.push('<br />');
        return controlTextList.join('');
    }

    google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body>
    Showing: <select onchange="addStyle(this.value);" id="selector" style="font-size: 14px"></select>
    <div id="map_canvas"></div>
</body>
</html>