<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <title>British Foreign &amp; Commonwealth Office (FCO) | Britons in trouble abroad | 2011-2012</title>
    <link rel="icon" type="image/vnd.microsoft.icon" href="http://www.fco.gov.uk/sitepack/layouts/xm_supplied/icon/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="css/jqModal.css" />
    <style type="text/css">
    html, body, #map_canvas {
       margin: 0;
       padding: 0;
       height: 100%;
       background-color: #fff;
    }
    body {
      font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    .embed-code {
      cursor: pointer;
      color: #666666;
      line-height: 21px;
      height: 21px;
      overflow: hidden;
      resize: none;
      white-space: nowrap;
      width: 576px;
      padding: 9px;
    }
    .small {
      font-size: 12px
    }
    .close {
      float: right;
    }
    .googft-info-window-title { 
        margin: 0 0 0.5em 0;
        font-weight: bold;
    }
    .googft-info-window-info { 
        margin: 0 0 1em 0;
        font-size: 0.9em;
    }
    .googft-info-window-additional {
        margin: 0.5em 0 0 0;
        padding: 0.5em 0 0 0;
        border: solid lightgray;
        border-width: 0.1em 0 0 0;
        font-size: 0.8em;
    }
    .key-text {
        padding-top: 0.5em;
    }
    </style>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3.7&amp;sensor=false"></script>
    <script type="text/javascript" src="js/jqModal.js"></script>
    <script type="text/javascript">
    var center = new google.maps.LatLng(32.0000, -5.0000);
    var zoom = 2;
    var legend_width = '150px';
    var tableid = '1aIVQ3cUzw9slE-A9GtrfajAQY0Z3JPh9bPD2R78';
    var location_column = 'geometry';
    var colors = {
      'NA': '#ffffff',
      'COLD': '#d4dd26',
      'CHILLY': '#d9a23c',
      'MILD': '#e06454',
      'WARM': '#bc234b',
      'HOT': '#bc234b'
    };
    var columns = {
      'Total assistance': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 20,
          'color': colors.CHILLY
        },
        {
          'min': 20,
          'max': 100,
          'color': colors.MILD
        },
        {
          'min': 100,
          'max': 1000,
          'color': colors.WARM
        },
        {
          'min': 1000,
          'max': 6000,
          'color': colors.HOT
        }
      ],
      'Drug arrests': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.WARM
        },
        {
          'min': 50,
          'max': 150,
          'color': colors.HOT
        }
      ],
      'Total arrests or detentions': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 20,
          'color': colors.CHILLY
        },
        {
          'min': 20,
          'max': 100,
          'color': colors.MILD
        },
        {
          'min': 100,
          'max': 1000,
          'color': colors.WARM
        },
        {
          'min': 1000,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Deaths': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 20,
          'color': colors.CHILLY
        },
        {
          'min': 20,
          'max': 100,
          'color': colors.MILD
        },
        {
          'min': 100,
          'max': 1000,
          'color': colors.WARM
        },
        {
          'min': 1000,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Hospitalisation': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 20,
          'color': colors.CHILLY
        },
        {
          'min': 20,
          'max': 100,
          'color': colors.MILD
        },
        {
          'min': 100,
          'max': 1000,
          'color': colors.WARM
        },
        {
          'min': 1000,
          'max': 2000,
          'color': colors.HOT
        }      
      ],
      'Victims of rape': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 15,
          'color': colors.WARM
        },
        {
          'min': 15,
          'max': 20,
          'color': colors.HOT
        }      
      ],
      'Victims of sexual assault': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.MILD
        },
        {
          'min': 10,
          'max': 15,
          'color': colors.WARM
        },
        {
          'min': 15,
          'max': 25,
          'color': colors.HOT
        }      
      ],
      'Issue of emergency travel documentation': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 20,
          'color': colors.CHILLY
        },
        {
          'min': 20,
          'max': 100,
          'color': colors.MILD
        },
        {
          'min': 100,
          'max': 1000,
          'color': colors.WARM
        },
        {
          'min': 1000,
          'max': 6000,
          'color': colors.HOT
        }      
      ],
      'Other kinds of assistance': [
        {
          'min': 0,
          'max': 5,
          'color': colors.NA
        },
        {
          'min': 5,
          'max': 10,
          'color': colors.CHILLY
        },
        {
          'min': 10,
          'max': 50,
          'color': colors.MILD
        },
        {
          'min': 50,
          'max': 100,
          'color': colors.WARM
        },
        {
          'min': 100,
          'max': 600,
          'color': colors.HOT
        }      
      ]
    };

    var map, layer, currentColumn, infoWindow;

    function GenericControl(controlDiv, map, label, title, callback) {
        // Set CSS styles for the DIV containing the control
        // Setting padding to 5 px will offset the control
        // from the edge of the map.
        controlDiv.style.padding = '5px';

        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = 'rgba(255,255,255,0.9)';
        controlUI.style.borderStyle = 'solid';
        controlUI.style.borderWidth = '1px';
        controlUI.style.cursor = 'pointer';
        controlUI.style.textAlign = 'center';
        controlUI.title = title;
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.fontFamily = 'Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.padding = '4px';
        controlText.innerHTML = label;
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        google.maps.event.addDomListener(controlUI, 'click', function() {
            callback.call(this);
        });
    }
    
    function LayerControl(controlDiv, options, map, callback) {
        controlDiv.style.padding = '5px';

        var controlUI = document.createElement('select');
        for(option in options) {
            var optionEl = document.createElement('option');
            optionEl.setAttribute('value', option);
            optionEl.innerHTML = option;
            controlUI.appendChild(optionEl);
        }

        controlUI.style.fontFamily = 'Arial,sans-serif';
        controlUI.style.fontSize = '12px';
        controlUI.title = 'Click to change the layer displayed';

        controlDiv.appendChild(controlUI);

        google.maps.event.addDomListener(controlUI, "change", function() {
            callback.call(this, this.value);
        });
    }

    function addGenericControl(map, label, title, index, callback) {
        var controlDiv = document.createElement('div');
        var control = new GenericControl(controlDiv, map, label, title, callback);

        controlDiv.index = index;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlDiv);

        return controlDiv;
    }


    function initialize() {

        map = new google.maps.Map(document.getElementById('map_canvas'), {
          center: center,
          zoom: zoom,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          disableDefaultUI: true,
          panControl: true,
          zoomControl: true,
          scaleControl: true
        });

        var style = [
          {
            featureType: "administrative",
            elementType: "all",
            stylers: [
              { visibility: "off" }
            ]
          },
          { 
            elementType: "labels", 
            stylers: [ 
              { saturation: -100 } 
            ] 
          },
          { 
            featureType: "poi",
            elementType: "all", 
            stylers: [ 
              { visibility: "off" }
            ] 
          },
          { 
            featureType: "landscape",
            elementType: "all", 
            stylers: [ 
              { visibility: "off" }
            ] 
          },
          { 
            featureType: "transit",
            elementType: "all", 
            stylers: [ 
              { visibility: "off" }
            ] 
          },
          { 
            featureType: "road", 
            elementType: "geometry", 
            stylers: [ 
              { lightness: -13 } 
            ] 
          }
          ,{ 
            featureType: "water", 
            elementType: "geometry", 
            stylers: [ 
              { visibility: "on" }, 
              { hue: "#44a2bc" },
              { lightness: -28 }, 
              { saturation: -20 }, 
              { gamma: 1.0 }
            ] 
          }
        ];

        var styledMapType = new google.maps.StyledMapType(style, {
          map: map,
          name: 'Styled Map'
        });

        map.mapTypes.set('map-style', styledMapType);
        map.setMapTypeId('map-style');

        infoWindow = new google.maps.InfoWindow();

        layer = new google.maps.FusionTablesLayer({
          query: {
            select: location_column,
            from: tableid
          },
          suppressInfoWindows: true
        });
        
        var clickListener = (function() {
          
          var template = "<div style='font-family:sans-serif' class='googft-info-window'>\
              <div class='googft-info-window-div googft-info-window-title'>\
                <span>{{country}}</span><br>\
              </div>\
              <div class='googft-info-window-div googft-info-window-info'>\
                <span><b>{{key}}:</b> {{value}}</span>\
              </div>\
              <div class='googft-info-window-div googft-info-window-additional'>\
                <span><a href='http://www.fco.gov.uk{{path}}' title='Travel advice for {{country}}' target='_top'>Travel advice for {{country}}</a></span>\
              </div>\
            </div>";

          return function(opts) {
            var value = opts.row[currentColumn.toLowerCase()].value;
            var renderedContent = (template
              .replace(/\{\{country\}\}/gm, opts.row.Country.value, 'm')
              .replace(/\{\{key\}\}/gm, currentColumn)
              .replace(/\{\{value\}\}/gm, value >= 5 && value || "Below threshold for counting")
              .replace(/\{\{path\}\}/gm, opts.row.path.value));

            infoWindow.close()
            infoWindow.setContent(renderedContent);
            infoWindow.setPosition(opts.latLng);
            infoWindow.open(map);
          };

        })();

        google.maps.event.addListener(layer, 'click', clickListener);

        layer.setMap(map);

        // Layer controls
        var layerControlDiv = document.createElement('div');
        var layerControl = new LayerControl(layerControlDiv, columns, map, addStyle);

        layerControlDiv.index = 3;
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(layerControlDiv);

        // Add embed control
        addGenericControl(map, "Embed", "Click to get the embed code for this map", 2, function() {
            $(".embed.jqmWindow").jqm({closeClass: 'close'}).jqmShow();
        });

        // Add about control
        addGenericControl(map, "About", "Click to read about this map", 1, function() {
            $(".about.jqmWindow").jqm({closeClass: 'close'}).jqmShow();
        });

        addStyle(getKey());
    }

    function getKey() {
        for (key in columns) {
          return key;
        }
    }

    // Apply the style to the layer
    function addStyle(column) {
        var defined_styles = columns[column];
        var styles = new Array();

        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          styles.push({
            where: generateWhere(column, style.min, style.max),
            polygonOptions: {
              fillColor: style.color,
              fillOpacity: style.opacity ? style.opacity : 1
            }
          });
        }

        layer.set('styles', styles);
        updateLegend(column);
        infoWindow.close();
        currentColumn = column;

        try {
          window.parent.$(window.parent.document).trigger("mapUpdated", column);
        } catch (err) {}
    }

    // Create the where clause
    function generateWhere(column_name, low, high) {
        var whereClause = new Array();
        whereClause.push("'");
        whereClause.push(column_name.toLowerCase());
        whereClause.push("' >= ");
        whereClause.push(low);
        whereClause.push(" AND '");
        whereClause.push(column_name.toLowerCase());
        whereClause.push("' < ");
        whereClause.push(high);
        return whereClause.join('');
    }

    // Create the legend with the corresponding colors
    function updateLegend(column) {
        var legendDiv = document.createElement('div');
        var legend = new Legend(legendDiv, column);
        legendDiv.index = 1;
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].pop();
        map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legendDiv);
    }

    // Generate the content for the legend
    function Legend(controlDiv, column) {
        controlDiv.style.padding = '10px';
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = 'white';
        controlUI.style.borderStyle = 'solid';
        controlUI.style.borderWidth = '1px';
        controlUI.style.width = legend_width;
        controlUI.title = 'Legend';
        controlDiv.appendChild(controlUI);
        var controlText = document.createElement('div');
        controlText.style.fontFamily = 'Arial,sans-serif';
        controlText.style.fontSize = '12px';
        controlText.style.paddingLeft = '4px';
        controlText.style.paddingRight = '4px';

        controlText.innerHTML = legendContent(column);
        controlUI.appendChild(controlText);
    }

    function legendContent(column) {
        var defined_styles = columns[column];

        // Generate the content for the legend using colors from object
        var controlTextList = new Array();
        controlTextList.push('<p><b>');
        controlTextList.push(column);
        controlTextList.push('</b></p>');
        for(defined_style in defined_styles) {
          var style = defined_styles[defined_style];
          if (style.max <= 5) {
            continue;
          }
          controlTextList.push('<div style="background-color: ');
          controlTextList.push(style.color);
          controlTextList.push('; height: 20px; width: 20px; margin: 3px; float: left;"></div>');
          controlTextList.push('<div class="key-text">' + style.min);
          controlTextList.push(' to ');
          controlTextList.push(style.max + '</div>');
          controlTextList.push('<br style="clear: both;"/>');
        }

        controlTextList.push('<br />');
        return controlTextList.join('');
    }

    google.maps.event.addDomListener(window, 'load', function () {
      
      initialize();

      var autoSelect = function() {
        $(this).focus().select();

        return this;
      };

      $("#embed-code").click(autoSelect);
    });
    </script>
</head>
<body>
    <div id="map_canvas"></div>
    
    <div class="embed jqmWindow">
      <h2>Embed<a class="small close" href="#">Close</a></h2>

      <div>
      <p>If you would like to embed this map on your blog or website, use this code:</p>
      <textarea id="embed-code" class="embed-code b2-text well" rows="1">&lt;iframe width=&quot;100%&quot; height=&quot;100%&quot; scrolling=&quot;no&quot; src=&quot;//fco-bba-2012.s3-website-eu-west-1.amazonaws.com/map.html&quot;&gt;&lt;/iframe&gt;</textarea>
      </div>
    </div>

    <div class="about jqmWindow">
      <h2>About<a class="small close" href="#">Close</a></h2>

      <p>These figures have been compiled from records of consular assistance provided by the Foreign and Commonwealth Office between April 2011 and March 2012. The combined data is publicly available as <a href="http://bit.ly/bba-data-2012" target="_top">a Google spreadsheet</a>.</p>

      <p class="small">Design inspired by the <a href="http://www.guardian.co.uk/news/datablog" target="_top">Guardian Datablog</a>.</p>
      <p class="small">Licensed under a <a href="http://creativecommons.org/licenses/by/3.0/" target="_top">Creative Commons Attribution 3.0 Unported License</a>.</p>
    </div>
    
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1903723-10']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>